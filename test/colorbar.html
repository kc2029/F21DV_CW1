<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>cDocument</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>

  <button id="start-transition">Start Transition</button>

  <script>
    // Set the dimensions of the SVG element
    const width = 246 * 20;
    const height = 400;

    // Load the data from the CSV file
    d3.csv("/data/covid.csv").then(function (data) {

      // Group the data by location
      const locations = d3.group(data.filter(d => !d.iso_code.includes("OWID")), d => d.location);

      console.log(locations)

      // Define the color scale for the cases
      const colorScale = d3.scaleSequential()
        .domain([0, d3.max(data, d => +d.total_deaths_per_million)])
        .interpolator(d3.interpolateReds);

      // Create a linear scale for the height of the bars
      const yScale = d3.scaleLinear()
        .domain([0, d3.max(data, d => +d.total_deaths_per_million)])
        .range([height - 100, 0]);

      // Create the SVG element
      const svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      // Create a group for each location
      const groups = svg.selectAll("g")
        .data(locations)
        .enter()
        .append("g")
        .attr("transform", function (d, i) {
          const x = (i * 20) + 100;
          return "translate(" + x + ", 0)";
        });

      const rects = groups.append("rect")
        .attr("x", -10)
        .attr("y", d => yScale(+d3.max(d[1], d => +d.total_deaths_per_million)))
        .attr("width", 20)
        .attr("height", d => (height) - yScale(+d3.max(d[1], d => +d.total_deaths_per_million)))
        .attr("fill", "white");






      function startTransition() {
        rects.transition()
          .duration(5000)
          .tween("fill", function (d) {
            const locationData = d[1];
            const maxCases = d3.max(locationData, d => +d.total_deaths_per_million);
            const interpolate = d3.interpolateRgb(colorScale(0), colorScale(maxCases));

            return function (t) {
              d3.select(this).attr("fill", interpolate(t));
            };
          });
      }

      // Handle button click event
      d3.select("#start-transition").on("click", startTransition);

    });


  </script>
</body>

</html>